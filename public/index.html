
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Presensi Siswa</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1e3a8a',
                        'secondary': '#64748b',
                        'success': '#16a34a',
                        'warning': '#eab308',
                        'danger': '#dc2626',
                    }
                }
            }
        }
    </script>
    <style>

         @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Loading Screen Styles */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }               

        #loadingScreen.fade-out {
            opacity: 0;
            visibility: hidden;
        }
        
        .loading-content {
            text-align: center;
            color: #374151;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10B981, #047857);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .loading-logo i {
            font-size: 40px;
            color: white;
        }
        
        .loading-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .loading-subtitle {
            font-size: 16px;
            opacity: 0.6;
            margin-bottom: 40px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #10B981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

               
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        
        .loading-dot {
            width: 12px;
            height: 12px;
            background: #10B981;
            border-radius: 50%;
            margin: 0 5px;
            animation: bounce 1.4s ease-in-out infinite both;
        }
        
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-dot:nth-child(3) { animation-delay: 0; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            } 40% {
                transform: scale(1);
            }
        }
        /* Hide main content initially */
        #mainContent {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        #mainContent.show {
            opacity: 1;
        }


        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .chart-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .chart-card {
            background-color: #ffffff; /* bg-white */
            border-radius: 0.5rem;    /* rounded-lg = 8px */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            padding: 1rem;            /* p-4 = 16px */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
        }


        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-title i {
            color: #667eea;
        }
        






        
       
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-hadir { background: linear-gradient(45deg, #10b981, #34d399); }
        .status-alpa { background: linear-gradient(45deg, #ef4444, #f87171); }
        .status-izin { background: linear-gradient(45deg, #f59e0b, #fbbf24); }
        .status-sakit { background: linear-gradient(45deg, #8b5cf6, #a78bfa); }
        .status-terlambat { background: linear-gradient(45deg, #f97316, #fb923c); }
        
/*         .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            animation: pulse 1.5s ease-in-out infinite;
        } */
        
        .status-online {
            background-color: #10b981;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .status-offline {
            background-color: #ef4444;
            animation: none;
        }
        
        .status-error {
            background-color: #f59e0b;
            animation: blink 1s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .refresh-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
/*         .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
            padding: 16px;
            margin-bottom: 12px;
            transform: translateX(100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.hide {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .toast-success { border-left-color: #10b981; }
        .toast-info { border-left-color: #3b82f6; }
        .toast-warning { border-left-color: #f59e0b; }
        .toast-error { border-left-color: #ef4444; } */

        .toast {
            position: fixed;
            top: 16px;
            right: 16px;
            left: 16px;
            z-index: 1000;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-100px);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        @media (min-width: 640px) {
            .toast {
                left: auto;
                min-width: 300px;
                max-width: 400px;
            }
        }
        
        .toast.show {
            transform: translateY(0);
        }
        
        .toast-success {
            background: #10b981;
            color: white;
        }
        
        .toast-error {
            background: #ef4444;
            color: white;
        }
        
        .toast-info {
            background: #3b82f6;
            color: white;
        }
        
        .toast-close {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .professional-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .professional-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        /* Glass morphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        /* Button styles */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(59, 130, 246, 0.4);
        }

        
        .professional-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="fas fa-qrcode"></i>
            </div>
            <div class="loading-title">Sistem Monitoring Presensi Siswa</div>
            <div class="loading-subtitle">Mempersiapkan aplikasi untuk Anda...</div>
            <div class="loading-spinner"></div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    

    <!-- Clean Header -->
    <!-- <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="container mx-auto px-6">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-user-check text-blue-600 text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">Sistem Presensi</h1>
                        <p class="text-xs text-gray-500">Real-time Monitoring</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center text-sm text-gray-600">
                        <div id="statusIndicator" class="loading-dot mr-2"></div>
                        <span id="statusText">Live</span>
                        <span id="lastUpdate" class="ml-2 text-xs text-gray-400"></span>
                        <span id="nextRefresh" class="ml-2 text-xs text-blue-400"></span>
                    </div>
                    <button onclick="checkCard()" class="border border-gray-300 text-gray-700 px-6 py-2.5 rounded-lg hover:bg-gray-50 transition-colors flex items-center space-x-2 font-medium">
                        <i class="fas fa-id-card"></i>
                        <span>Cek Kartu Presensi</span>
                    </button>
                </div>
            </div>
        </div>
    </header> -->
    <header class="glass sticky top-0 z-40 border-b border-gray-200/80">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16 sm:h-20">
            
            <!-- Bagian Kiri: Logo dan Judul -->
            <div class="flex items-center space-x-2 sm:space-x-4">
                <div class="w-9 h-9 sm:w-11 sm:h-11 rounded-xl flex items-center justify-center">
                    <img src="../THIRD LOWER-logo.svg" alt="Logo SMP" class="w-7 h-7 sm:w-9 sm:h-9 inline-block">
                </div>
                <div class="hidden sm:block">
                    <h1 class="text-lg sm:text-xl font-bold bg-gradient-to-r from-green-600 to-indigo-600 bg-clip-text ">
                        Sistem Presensi
                    </h1>
                    <p class="text-xs text-gray-500">Real-time Monitoring</p>
                </div>
                <div class="block sm:hidden">
                    <h1 class="text-sm font-bold bg-gradient-to-r from-from-green-600 to-indigo-600 bg-clip-text ">
                        Sistem Presensi
                    </h1>
                </div>
            </div>

            <!-- Bagian Tengah: Menu Desktop (Warna Gelap & Primary) -->
            <nav class="hidden md:flex items-center space-x-8">
                <!-- Menu Aktif -->
                <a href="#" onclick="showDashboard()" class="text-primary font-medium border-b-2 border-primary pb-2">
                    Dashboard
                </a>
                <!-- Menu Tidak Aktif -->
                <a href="https://ediamiruddin09-eng.github.io/webpresensi/public/rekap.html" onclick="showRekap()" class="text-gray-700 hover:text-primary transition-colors font-medium border-b-2 border-transparent hover:border-primary pb-2">
                    Rekap Presensi
                </a>
                <a href="#" onclick="showCetakKartu()" class="text-gray-700 hover:text-primary transition-colors font-medium border-b-2 border-transparent hover:border-primary pb-2">
                    Cetak Kartu
                </a>
            </nav>

            <!-- Bagian Kanan: Tombol & Hamburger -->
            <div class="flex items-center space-x-2 sm:space-x-4">
                <button id="refreshButton" onclick="manualRefresh()" class="btn-touch bg-white text-primary hover:bg-blue-50 px-3 sm:px-4 py-2 sm:py-2.5 rounded-xl font-medium flex items-center space-x-2 text-sm border border-primary">
                    <i id="refreshIcon" class="fas fa-sync-alt"></i>
                    <span class="hidden sm:inline">Refresh</span>
                </button>
                <div id="connectionStatus" class="hidden lg:flex items-center space-x-2 text-sm text-gray-600">
                    <div id="statusIndicator" class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span id="statusText">Live</span>
                    <span id="lastUpdate" class="text-xs text-gray-400"></span>
                    <span id="nextRefresh" class="text-xs text-blue-400"></span>
                </div>     
                
                <!-- Tombol Hamburger (Warna Gelap) -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-800 hover:bg-gray-200/50 focus:outline-none">
                        <span class="sr-only">Buka menu</span>
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Panel Menu Mobile (Warna Gelap & Primary) -->
    <div id="mobile-menu" class="hidden md:hidden">
        <div class="px-2 pt-2 pb-3 space-y-2 sm:px-3">
            <!-- Menu Aktif -->
            <a href="#" onclick="showDashboard()" class="block text-center text-white bg-blue-600 px-3 py-3 rounded-lg text-base font-medium shadow-sm">
                Dashboard
            </a>
            <!-- Menu Tidak Aktif -->
            <a href="https://ediamiruddin09-eng.github.io/webpresensi/public/rekap.html" onclick="showRekap()" class="block text-center text-gray-800 bg-gray-100 hover:bg-blue-100 hover:text-blue-700 px-3 py-3 rounded-lg text-base font-medium transition-colors shadow-sm">
                Rekap Presensi
            </a>
            <a href="#" onclick="showCetakKartu()" class="block text-center text-gray-800 bg-gray-100 hover:bg-blue-100 hover:text-blue-700 px-3 py-3 rounded-lg text-base font-medium transition-colors shadow-sm">
                Cetak Kartu
            </a>
        </div>
    </div>
</header>



<script>
    // Skrip untuk toggle menu mobile
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');

    mobileMenuButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
    });

    // Anda perlu mendefinisikan fungsi-fungsi ini di file JS utama Anda
    function showDashboard() {
        console.log("Menampilkan Dashboard...");
        // Tambahkan logika untuk menampilkan konten dashboard di sini
    }
    function showRekap() {
        console.log("Menampilkan Rekap Presensi...");
        // Tambahkan logika untuk menampilkan konten rekap di sini
    }
    function showCetakKartu() {
        console.log("Menampilkan Cetak Kartu...");
        // Tambahkan logika untuk menampilkan konten cetak kartu di sini
    }
</script>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
        <div class="mb-6 sm:mb-8">
            <div class="text-center mb-6 sm:mb-8">
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Dashboard Presensi</h2>
                <p class="text-sm sm:text-base text-gray-600">Monitoring kehadiran siswa secara real-time</p>
            </div>
             <div class="flex items-center justify-center w-full gap-2">
    <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-50 border border-slate-200 text-sm text-slate-600">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M8 7h8M8 12h8M8 17h5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.6" fill="none"/>
        </svg>
        <span id="dateLabel">-</span>
    </div>
</div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
<!--         Dashboard statistik baru  -->
        <!-- Summary Cards -->
         
        
        <!-- Statistik Baru -->
         <!-- Daily Results -->

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6 w-full max-w-full">
            <!-- Total Siswa -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 flex items-center justify-center bg-blue-100 text-blue-600 rounded-lg mr-3">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Total Siswa</p>
                        <p class="text-xl font-bold text-gray-800">384</p>
                    </div>
                </div>
            </div>
            <!-- Hadir -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 flex items-center justify-center bg-green-100 text-green-600 rounded-lg mr-3">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Hadir Hari Ini</p>
                        <p class="text-xl font-bold text-green-600" id="presentCount">0</p>
                    </div>
                </div>
            </div>
            <!-- Tidak Hadir -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 flex items-center justify-center bg-red-100 text-red-600 rounded-lg mr-3">
                        <i class="fas fa-times-circle text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Tidak Hadir</p>
                        <p class="text-xl font-bold text-red-600" id="absentCount">0</p>
                    </div>
                </div>
            </div>
            <!-- Persentase Hadir -->
            <div class="bg-white rounded-lg shadow-sm border p-4">
                <div class="flex items-center">
                    <div class="w-12 h-12 flex items-center justify-center bg-yellow-100 text-yellow-600 rounded-lg mr-3">
                        <i class="fas fa-percentage text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Persentase Hadir</p>
                        <p class="text-xl font-bold text-yellow-600" id="attendanceRate">0%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kehadiran Detail Cards -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 mb-6 w-full max-w-full">
            <!-- Alpa -->
            <div class="bg-white rounded-lg shadow-sm border p-4 flex items-center">
                <div class="w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-xl mr-3">
                    <i class="fas fa-times text-lg"></i>
                </div>
                <div>
                    <p class="text-gray-600 text-xs">Alpa</p>
                    <p class="text-lg font-bold text-red-600" id="countAlpa">0</p>
                </div>
            </div>
            <!-- Sakit -->
            <div class="bg-white rounded-lg shadow-sm border p-4 flex items-center">
                <div class="w-10 h-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-xl mr-3">
                    <i class="fas fa-thermometer-half text-lg"></i>
                </div>
                <div>
                    <p class="text-gray-600 text-xs">Sakit</p>
                    <p class="text-lg font-bold text-blue-600" id="countSakit">0</p>
                </div>
            </div>
            <!-- Izin -->
            <div class="bg-white rounded-lg shadow-sm border p-4 flex items-center">
                <div class="w-10 h-10 flex items-center justify-center bg-yellow-100 text-yellow-600 rounded-xl mr-3">
                    <i class="fas fa-hand-paper text-lg"></i>
                </div>
                <div>
                    <p class="text-gray-600 text-xs">Izin</p>
                    <p class="text-lg font-bold text-yellow-600" id="countIzin">0</p>
                </div>
            </div>
            <!-- Bolos -->
            <div class="bg-white rounded-lg shadow-sm border p-4 flex items-center">
                <div class="w-10 h-10 flex items-center justify-center bg-purple-100 text-purple-600 rounded-xl mr-3">
                    <i class="fas fa-user-slash text-lg"></i>
                </div>
                <div>
                    <p class="text-gray-600 text-xs">Bolos</p>
                    <p class="text-lg font-bold text-purple-600" id="countBolos">0</p>
                </div>
            </div>
            <!-- Terlambat -->
            <div class="bg-white rounded-lg shadow-sm border p-4 flex items-center">
                <div class="w-10 h-10 flex items-center justify-center bg-orange-100 text-orange-600 rounded-xl mr-3">
                    <i class="fas fa-clock text-lg"></i>
                </div>
                <div>
                    <p class="text-gray-600 text-xs">Terlambat</p>
                    <p class="text-lg font-bold text-orange-600" id="countTerlambat">0</p>
                </div>
            </div>
            <!-- Belum Presensi -->
            <div class="bg-white rounded-lg shadow-sm border p-4 flex items-center">
                <div class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-600 rounded-xl mr-3">
                    <i class="fas fa-question text-lg"></i>
                </div>
                <div>
                    <p class="text-gray-600 text-xs">Belum Presensi</p>
                    <p class="text-lg font-bold text-gray-600" id="otherCount">0</p>
                </div>
            </div>
        </div>         
    
        
        <!-- Tabel Statistik Semua Kelas -->
        <!-- <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 space-y-6 w-full max-w-full"> -->
            <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 ">
                    <div class="glass-card chart-card">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-pie"></i>
                            Distribusi Kehadiran
                        </h3>
                        <div class="chart-container">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card chart-card">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            Statistik Kehadiran
                        </h3>
                        <div class="chart-container">
                            <canvas id="dailyBarChart"></canvas>
                        </div>
                    </div>
                </div>
        <!-- </div> -->

        




        <div class="grid gap-8 py-8">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-table mr-2 text-blue-600"></i>
                Statistik Kehadiran Hari Ini
            </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-300 text-sm text-left">
            <thead class="bg-gray-100 text-gray-700">
                <tr>
                <th class="px-4 py-2 border">Kelas</th>
                <th class="px-4 py-2 border">Total Siswa</th>
                <th class="px-4 py-2 border">Hadir</th>
                <th class="px-4 py-2 border">Alpa</th>
                <th class="px-4 py-2 border">Izin</th>
                <th class="px-4 py-2 border">Sakit</th>
                <th class="px-4 py-2 border">Terlambat</th>
                <th class="px-4 py-2 border">Bolos</th>
                <th class="px-4 py-2 border">Belum Presensi</th>
                <th class="px-4 py-2 border">Total Presensi</th>
                <th class="px-4 py-2 border">Persen Hadir</th>
                </tr>
            </thead>
            <tbody id="statistikTableBody">
                <!-- Data kelas akan dimuat otomatis -->
            </tbody>
            </table>
        </div>
        </div>
        </div>


        
        <!-- Main Content Grid -->
        <div class="grid ">
            <!-- Riwayat Presensi Terbaru -->
            <div class="bg-white p-2 animate-fade-in rounded-lg shadow-sm border border-gray-200 w-full max-w-full">
                <div class="p-4 sm:p-2 border-b border-gray-200">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center flex-wrap">
                        <i class="fas fa-history mr-2 text-blue-600"></i>
                        Riwayat Presensi Terbaru
                        <span class="ml-2 mt-1 sm:mt-0 text-xs sm:text-sm bg-blue-100 text-blue-600 px-2 py-1 rounded-full">
                            10 Data Terbaru
                        </span>
                    </h2>
                </div>
                
                <div class="p-6">
                    <div id="recentAttendance" class="space-y-3">
                        <!-- Data akan dimuat di sini -->
                    </div>
                    
                    <div id="noRecentData" class="text-center py-8 hidden">
                        <i class="fas fa-inbox text-3xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500">Belum ada data presensi terbaru</p>
                    </div>
                </div>
            </div>
            
        </div>
            </div>
<!--         </div>
    </div> -->
    
    <!-- Footer dengan gradient -->
    <footer class="bg-white border-t border-gray-200 mt-12 py-8">                            
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">     
                <!-- School Info -->
                <div class="col-span-1 md:col-span-2">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-9 h-9 sm:w-11 sm:h-11  rounded-xl flex items-center justify-center">
                    <!-- <i class="fas fa-user-check text-white text-sm sm:text-lg"></i> -->
                            <img src="../THIRD LOWER-logo.svg" alt="Logo SMP" class="w-7 h-7 sm:w-9 sm:h-9 inline-block">
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">UPT SMP NEGERI 1 SUPPA</h3>
                            <p class="text-sm text-gray-500">Sistem Presensi Digital</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">
                        Sistem presensi digital yang memudahkan monitoring kehadiran siswa secara real-time dengan teknologi modern dan user-friendly interface.
                    </p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fab fa-facebook-f text-lg"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fab fa-tiktok text-lg"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fab fa-instagram text-lg"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fab fa-youtube text-lg"></i>
                        </a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wider mb-4">Fitur Utama</h4>
                    <ul class="space-y-3">
                        <li class="flex items-center space-x-2">
                            <i class="fas fa-check text-green-400 text-sm"></i>
                            <span class="text-sm text-gray-600">Monitoring Real-time</span>
                        </li>
                        <li class="flex items-center space-x-2">
                            <i class="fas fa-check text-green-400 text-sm"></i>
                            <span class="text-sm text-gray-600">Terintegrasi WhatsApp</span>
                        </li>
                        <li class="flex items-center space-x-2">
                            <i class="fas fa-check text-green-400 text-sm"></i>
                            <span class="text-sm text-gray-600">Rekap Presensi</span>
                        </li>
                        <li class="flex items-center space-x-2">
                            <i class="fas fa-check text-green-400 text-sm"></i>
                            <span class="text-sm text-gray-600">Statistik Lengkap</span>
                        </li>
                        
                    </ul>
                </div>

                <!-- Contact Info -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wider mb-4">Kontak</h4>
                    <ul class="space-y-3">
                        <li class="flex items-start">
                            <i class="fas fa-map-marker-alt text-gray-400 w-4 mt-1 mr-3"></i>
                            <span class="text-sm text-gray-600">
                                Jl. Ambo Siraje No.1<br>
                                Kec. Suppa, Kab. Pinrang
                            </span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-phone text-gray-400 w-4 mr-3"></i>
                            <span class="text-sm text-gray-600">0852-4664-1084</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope text-gray-400 w-4 mr-3"></i>
                            <span class="text-sm text-gray-600">spensasuppa@gmail.com</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-globe text-gray-400 w-4 mr-3"></i>
                            <span class="text-sm text-gray-600">www.smpn1suppa.sch.id</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Footer -->
            <div class="border-t border-gray-200 mt-8 pt-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center space-x-6 mb-4 md:mb-0">
                        <p class="text-sm text-gray-500">
                            © 2025 UPT SMP Negeri 1 Suppa. All rights reserved.
                        </p>
                        
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <i class="fas fa-code text-primary"></i>
                        <span>Powered by</span>
                        <span class="font-medium text-primary">TIM IT SPENSA SUPPA</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    </div>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script src="app.js"></script>
    

    <script>
        // Loading screen functionality
        window.addEventListener('load', function() {
            // Simulate minimum loading time for better UX
            setTimeout(function() {
                const loadingScreen = document.getElementById('loadingScreen');
                const mainContent = document.getElementById('mainContent');
                
                // Fade out loading screen
                loadingScreen.classList.add('fade-out');
                
                // Show main content after loading screen fades out
                setTimeout(function() {
                    mainContent.classList.add('show');
                    document.body.style.overflow = 'auto'; // Re-enable scrolling
                }, 500);
                
            }, 1500); // Minimum 1.5 second loading time
        });
        
        // Initially disable scrolling
        document.body.style.overflow = 'hidden';





        
        // Konfigurasi Google Sheets
        const SHEET_ID = '1LvWRd5YkB9zM5LZaMhc07FgIQMwH4cuCrmDsPhYMlYM';
        const API_KEY = 'AIzaSyAJZCA_UFQPi_bJLPyhIX82zevOWq9BTZI';
        const RANGE = 'Sheet1!A:O';
        
        // Variabel global
        
        let allData = [];

        // Chart instances for cleanup
        let pieChart = null;
        let dailyBarChart = null;

        // let filteredData = [];
        let lastDataCount = 0;
        let refreshInterval;
        let countdownInterval;
        let isOnline = navigator.onLine;
        let consecutiveErrors = 0;
        let lastUpdateTime = null;
        let refreshRate = 10000; // 10 detik default
        let nextRefreshTime = null;
        // let refreshIntervalId; // Variabel global untuk menyimpan ID dari setInterval
        
        // Toast Notification System
        // Toast notification function
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            toast.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 mr-3">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'} text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium">${message}</p>
                    </div>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Show toast with animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Auto remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }
        
        function closeToast(button) {
            const toast = button.closest('.toast');
            toast.classList.add('hide');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
        
        // Fungsi untuk mengambil data dari Google Sheets
        // Fungsi untuk mengambil data dari Google Sheets
async function fetchDataFromSheets(showLoading = false) {
    if (showLoading) {
        updateConnectionStatus('loading', 'Memuat data...');
    }
    
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.values && data.values.length > 1) {
            // ---- MODIFIKASI DI SINI ----
            // Ambil semua baris kecuali header, lalu langsung balik urutannya.
            // Data yang paling baru (di baris bawah sheet) kini akan berada di awal array.
            const rows = data.values.slice(1).reverse(); 
            // -----------------------------

            const newDataCount = rows.length;
            
            // Reset error counter on successful fetch
            consecutiveErrors = 0;
            
            // Cek apakah ada data baru (logika ini tetap berfungsi dengan benar)
            if (newDataCount > lastDataCount && lastDataCount > 0) {
                const newRecords = newDataCount - lastDataCount;
                showToast(`${newRecords} data presensi baru ditambahkan!`, 'success');
                
                // Play notification sound (optional)
                playNotificationSound();
            }
            lastDataCount = newDataCount;
            
            // Update timestamp
            lastUpdateTime = new Date();
            
            // Proses mapping sekarang akan memproses data dari yang terbaru ke yang terlama
            allData = rows.map(row => ({
                date: row[3] || '',
                tanggal: row[1] || '',
                bulan: row[3] || '',
                jam: row[4] || '',
                scan: row[5] || '',
                namaSiswa: row[7] || '',
                namaLengkap: row[6] || '',
                nohp: row[8] || '',
                rombel: row[9] || '',
                kelas: row[10] || '',
                keterangan: row[11] || '',
                catatan: row[12] || '',
                mataPelajaran: row[13] || '',
                jamPelajaran: row[14] || ''
            }));
            
            // Panggil fungsi-fungsi lain untuk update tampilan
            updateStatistics();
            // populateFilters();
            displayRecentAttendance(); // Fungsi ini akan menerima allData yang sudah terurut BARU ke LAMA
            // displayPeriodRecap();
            
            updateConnectionStatus('online', 'Terhubung');
        } else {
            updateConnectionStatus('online', 'Tidak ada data');
        }
        
        return Promise.resolve();
        
    } catch (error) {
        console.error('Error fetching data:', error);
        consecutiveErrors++;
        
        if (consecutiveErrors >= 3) {
            updateConnectionStatus('error', 'Koneksi bermasalah');
            showToast('Koneksi tidak stabil. Mencoba ulang...', 'warning');
        } else {
            updateConnectionStatus('error', 'Gagal memuat');
        }
        
        return Promise.reject(error);
    }
}
        
       

// Ganti URL_APLIKASI_WEB dengan URL yang Anda dapatkan di Langkah 2
// const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwFO59Hi1pyMgy3Eyi7-y0Ow0Dxr0VNAEfy2ouLNK8TXGt8SdhtoDF-TTLox_ZVV2RyoQ/exec'; 


// Fungsi untuk mengambil dan memperbarui statistik dari Google Apps Script
const scriptURL = "https://script.google.com/macros/s/AKfycbyvBMOFQ2oYY-PIaMpzejTBmxEp1mRHnm4OLu56_JG7GeeNAGBflsE2b6nND3Dcjj_zrw/exec"; // ganti dengan URL Web App Anda

  const allowedClasses = [
    "7A","7B","7C","7D","7E",
    "8A","8B","8C","8D",
    "9A","9B","9C","9D","9E"
  ];
  const allowedIndex = allowedClasses.reduce((a,v,i)=>{a[v]=i;return a;},{})

  function normalizeClass(v){
    return String(v||"").trim().toUpperCase();
  }

  async function loadStatistikUmum() {
      try {
        const res = await fetch(`${scriptURL}?action=umum`);
        const data = await res.json();

        const totalHadir = Number(data["TOTAL HADIR"]) || 0;
        const totalAlpa = Number(data["TOTAL ALPA"]) || 0;
        const totalIzin = Number(data["TOTAL IZIN"]) || 0;
        const totalSakit = Number(data["TOTAL SAKIT"]) || 0;
        const totalTerlambat = Number(data["TOTAL TERLAMBAT"]) || 0;
        const totalBolos = Number(data["TOTAL BOLOS"]) || 0;
        const belumPresensi = Number(data["BELUM PRESENSI"]) || 0;
        const totalPresensi = Number(data["TOTAL PRESENSI"]) || 0;
        const persenHadir = Number(data["PERSENTASE HADIR"]) || 0;

        document.getElementById("presentCount").textContent = totalHadir;
        document.getElementById("absentCount").textContent = totalAlpa + totalIzin + totalSakit + totalBolos;
        document.getElementById("attendanceRate").textContent =
          totalPresensi > 0 ? ((totalHadir / 384) * 100).toFixed(1) + "%" : "0%";

        document.getElementById("countAlpa").textContent = totalAlpa;
        document.getElementById("countSakit").textContent = totalSakit;
        document.getElementById("countIzin").textContent = totalIzin;
        document.getElementById("countBolos").textContent = totalBolos;
        document.getElementById("countTerlambat").textContent = totalTerlambat;
        document.getElementById("otherCount").textContent = belumPresensi;
        // document.getElementById("totalStudents").textContent = totalPresensi + belumPresensi;
        // 🔹 Panggil chart setelah data terisi
        createPieChart({
        hadir: totalHadir,
        alpa: totalAlpa,
        izin: totalIzin,
        sakit: totalSakit,
        terlambat: totalTerlambat,
        bolos: totalBolos,
        other: belumPresensi
        });

        createDailyBarChart({
        hadir: totalHadir,
        alpa: totalAlpa,
        izin: totalIzin,
        sakit: totalSakit,
        terlambat: totalTerlambat,
        bolos: totalBolos
        });




      } catch (err) {
        console.error("Error loadStatistikUmum:", err);
      }

      
    }

  async function updateStatistics(){
    try{
      const res = await fetch(`${scriptURL}?action=kelas`);
      const data = await res.json();
      const tbody = document.getElementById("statistikTableBody");

      // Filter + urutkan sesuai allowedClasses
      const filtered = data
        .filter(r => allowedClasses.includes(normalizeClass(r["Kelas"])))
        .sort((a,b)=>allowedIndex[normalizeClass(a["Kelas"])]-allowedIndex[normalizeClass(b["Kelas"])]);

      let rows = "";
      filtered.forEach(row=>{
        const kelas = normalizeClass(row["Kelas"]);
        const show = v => (v===""||v==null? "-" : v);

        let persen = parseFloat(row["PERSENTASE HADIR"]);
        if(!isNaN(persen) && persen<=1) persen *= 100; // kalau masih 0–1
        const persenText = isNaN(persen)? "-" : persen.toFixed(2)+"%";
        const persenClass = (!isNaN(persen)&&persen>=75)
            ? "text-green-600 font-semibold"
            : "text-red-600 font-semibold";

        rows += `
          <tr>
            <td class="px-4 py-2 border">${kelas}</td>
            <td class="px-4 py-2 border">${show(row["TOTAL SISWA"])}</td>
            <td class="px-4 py-2 border">${show(row["TOTAL HADIR"])}</td>
            <td class="px-4 py-2 border">${show(row["TOTAL ALPA"])}</td>
            <td class="px-4 py-2 border">${show(row["TOTAL IZIN"])}</td>
            <td class="px-4 py-2 border">${show(row["TOTAL SAKIT"])}</td>
            <td class="px-4 py-2 border">${show(row["TOTAL TERLAMBAT"])}</td>
            <td class="px-4 py-2 border">${show(row["TOTAL BOLOS"])}</td>
            <td class="px-4 py-2 border">${show(row["BELUM PRESENSI"])}</td>
            <td class="px-4 py-2 border">${show(row["TOTAL PRESENSI"])}</td>
            <td class="px-4 py-2 border ${persenClass}">${persenText}</td>
          </tr>`;
      });

      tbody.innerHTML = rows || `<tr><td colspan="11" class="px-4 py-2 border text-gray-500">Tidak ada data</td></tr>`;
    }catch(err){
      console.error("Error:",err);
      document.getElementById("statistikTableBody").innerHTML =
        `<tr><td colspan="11" class="px-4 py-2 border text-red-600">Gagal memuat data</td></tr>`;
    }
  }

        // Panggil fungsi ini saat halaman dimuat
        updateStatistics();     
        loadStatistikUmum();

        ///////////////////////////////////////////
        
        function createPieChart(stats) {
        const ctx = document.getElementById('pieChart').getContext('2d');

        if (pieChart) {
            pieChart.destroy();
        }

        const total = stats.hadir + stats.alpa + stats.izin + stats.sakit + stats.terlambat + stats.bolos + stats.other;
        const persenHadir = total > 0 ? Math.round((stats.hadir / total) * 100) : 0;

        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
            labels: ['Hadir', 'Alpa', 'Izin', 'Sakit', 'Terlambat', 'Bolos', 'Belum Presensi'],
            datasets: [{
                data: [
                stats.hadir,
                stats.alpa,
                stats.izin,
                stats.sakit,
                stats.terlambat,
                stats.bolos,
                stats.other
                ],
                backgroundColor: [
                '#10b981', // Hadir
                '#ef4444', // Alpa
                '#f59e0b', // Izin
                '#8b5cf6', // Sakit
                '#f97316', // Terlambat
                '#374151', // Bolos
                '#9ca3af'  // Belum Presensi
                ],
                borderWidth: 3,
                borderColor: '#fff',
                cutout: '60%'
            }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                position: 'bottom',
                labels: { usePointStyle: true }
                },
                tooltip: {
                callbacks: {
                    label: function(context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: ${context.parsed} siswa (${percentage}%)`;
                    }
                }
                }
            }
            },
            plugins: [{
            id: 'centerText',
            beforeDraw: function(chart) {
                const ctx = chart.ctx;
                const {width, height} = chart;
                const centerX = width / 2;
                const centerY = height / 2;

                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = 'bold 22px Inter';
                ctx.fillStyle = persenHadir >= 75 ? '#10b981' : persenHadir >= 60 ? '#f59e0b' : '#ef4444';
                ctx.fillText(persenHadir + "%", centerX, centerY - 10);

                ctx.font = '12px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText("Tingkat Kehadiran", centerX, centerY + 15);
                ctx.restore();
            }
            }]
        });
        }

        // Function untuk buat bar chart harian
  function createDailyBarChart(stats) {
    const ctx = document.getElementById('dailyBarChart');
    if (!ctx) return;

    // Hapus chart lama
    if (dailyBarChart) {
      dailyBarChart.destroy();
      dailyBarChart = null;
    }

    const labels = ['Hadir', 'Alpa', 'Izin', 'Sakit', 'Terlambat', 'Bolos'];
    const values = [
      stats.hadir || 0,
      stats.alpa || 0,
      stats.izin || 0,
      stats.sakit || 0,
      stats.terlambat || 0,
      stats.bolos || 0
    ];

    const backgroundColors = [
      'rgba(16, 185, 129, 0.8)', // hijau
      'rgba(239, 68, 68, 0.8)',  // merah
      'rgba(245, 158, 11, 0.8)', // kuning
      'rgba(139, 92, 246, 0.8)', // ungu
      'rgba(249, 115, 22, 0.8)', // oranye
      'rgba(107, 114, 128, 0.8)' // abu
    ];

    const borderColors = [
      '#10b981',
      '#ef4444',
      '#f59e0b',
      '#8b5cf6',
      '#f97316',
      '#6b7280'
    ];

    const data = {
      labels: labels,
      datasets: [{
        label: 'Jumlah Siswa',
        data: values,
        backgroundColor: backgroundColors,
        borderColor: borderColors,
        borderWidth: 2,
        borderRadius: 8,
        maxBarThickness: 60
      }]
    };

    try {
      dailyBarChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#ffffff',
              borderWidth: 1,
              cornerRadius: 8,
              callbacks: {
                title: function(context) {
                  return `Status: ${context[0].label}`;
                },
                label: function(context) {
                  const total = values.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                  return `Jumlah: ${context.parsed.y} siswa (${percentage}%)`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: { family: 'Inter', size: 11 },
                color: '#64748b',
                callback: function(value) {
                  return Number.isInteger(value) ? value : '';
                }
              },
              grid: { color: 'rgba(148, 163, 184, 0.2)', drawBorder: false },
              border: { display: false }
            },
            x: {
              ticks: {
                font: { family: 'Inter', size: 11, weight: '500' },
                color: '#475569',
                maxRotation: 0
              },
              grid: { display: false },
              border: { display: false }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeOutQuart',
            delay: (context) => context.dataIndex * 100
          }
        }
      });
    } catch (error) {
      console.error('Error creating bar chart:', error);
    }
  }



    









        ////////////////////////////////////////////
                
        // Fungsi untuk menampilkan rekap kelas
        function displayClassRecap(selectedClass) {
            const display = document.getElementById('classRekapDisplay');
            const content = document.getElementById('classRekapContent');
            const className = document.getElementById('selectedClassName');
            
            if (!selectedClass) {
                display.classList.add('hidden');
                return;
            }
            
            const classData = allData.filter(item => item.kelas === selectedClass);
            
            if (classData.length === 0) {
                display.classList.add('hidden');
                return;
            }
            
            const stats = {
                hadir: classData.filter(item => item.keterangan.toLowerCase().includes('hadir')).length,
                alpa: classData.filter(item => item.keterangan.toLowerCase().includes('alpa')).length,
                sakit: classData.filter(item => item.keterangan.toLowerCase().includes('sakit')).length,
                izin: classData.filter(item => item.keterangan.toLowerCase().includes('izin')).length,
                terlambat: classData.filter(item => item.keterangan.toLowerCase().includes('terlambat')).length
            };
            
            stats.total = stats.hadir + stats.alpa + stats.sakit + stats.izin + stats.terlambat;
            
            className.textContent = selectedClass;
            content.innerHTML = `
                <div class="text-center p-4 bg-green-50 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">${stats.hadir}</div>
                    <div class="text-sm text-gray-600">Hadir</div>
                </div>
                <div class="text-center p-4 bg-red-50 rounded-lg">
                    <div class="text-2xl font-bold text-red-600">${stats.alpa}</div>
                    <div class="text-sm text-gray-600">Alpa</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600">${stats.sakit}</div>
                    <div class="text-sm text-gray-600">Sakit</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600">${stats.izin}</div>
                    <div class="text-sm text-gray-600">Izin</div>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">${stats.total}</div>
                    <div class="text-sm text-gray-600">Total</div>
                </div>
            `;
            
            display.classList.remove('hidden');
        }
        
        
         // Fungsi untuk menampilkan riwayat presensi terbaru
        function displayRecentAttendance() {
            const container = document.getElementById('recentAttendance');
            const noDataMessage = document.getElementById('noRecentData');
            
            // Urutkan berdasarkan waktu terbaru dan ambil 10 terakhir
            const recentData = [...allData]
                .sort((a, b) => {
                    const dateTimeA = new Date(a.date + ' ' + a.jam);
                    const dateTimeB = new Date(b.date + ' ' + b.jam);
                    return dateTimeB - dateTimeA;
                })
                .slice(0, 10);
            
            if (recentData.length === 0) {
                container.classList.add('hidden');
                noDataMessage.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            noDataMessage.classList.add('hidden');
            
            // Cek apakah ada perubahan data
            const currentDataString = JSON.stringify(recentData);
            if (container.dataset.lastData === currentDataString) {
                return; // Tidak ada perubahan, tidak perlu update
            }
            container.dataset.lastData = currentDataString;
            
            // Animate new data
            // Animate new data
                container.style.opacity = '0.7';
                setTimeout(() => {
                    container.innerHTML = '';
                    
                    recentData.forEach((item, index) => {
                        const statusClass = getStatusClass(item.keterangan);
                        const statusBadge = getStatusBadge(item.keterangan);
                        const div = document.createElement('div');
                        
                        // Mengurangi padding dan menambahkan gap untuk elemen yang lebih rapat
                        div.className = `
                            flex flex-col sm:flex-row sm:items-center sm:justify-between 
                            p-2 sm:p-2 bg-white border border-gray-100 rounded-md 
                            hover:shadow-sm transition-all duration-200 animate-fade-in
                        `;
                        div.style.animationDelay = `${index * 50}ms`;
                        
                        div.innerHTML = `
                            <div class="flex items-center space-x-2 w-full sm:w-auto">
                                <div class="relative flex-shrink-0">
                                   <div class="w-8 h-8 rounded-full ${statusClass} 
                                        flex items-center justify-center text-white font-bold shadow-sm text-xs">
                                        ${getStatusIcon(item.keterangan)}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-1 mb-0 flex-wrap">
                                        <h6 class="font-semibold text-gray-900 text-sm truncate max-w-[200px]">
                                            ${item.namaLengkap || item.namaSiswa}
                                        </h6>
                                        ${statusBadge}
                                    </div>
                                    <div class="flex flex-wrap gap-1 text-[10px] text-gray-500">
                                        <span class="flex items-center truncate">
                                            <i class="fas fa-graduation-cap mr-0.5"></i>
                                            ${item.kelas}
                                        </span>
                                        <span class="flex items-center truncate">
                                            <i class="fas fa-book mr-0.5"></i>
                                            ${item.mataPelajaran}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-left sm:text-right mt-1 sm:mt-0">
                                <div class="text-xs sm:text-sm font-medium text-gray-900 mb-1">${formatDate(item.tanggal)}</div>
                        <div class="text-xs sm:text-sm text-gray-500 flex items-center sm:justify-end">
                            <i class="fas fa-clock mr-1"></i>
                            ${item.jam}
                        </div>

                            </div>
                        `;
                            
                        container.appendChild(div);
                    });
                    
                    container.style.opacity = '1';
                }, 150);
        }
        
        // Helper function untuk format tanggal
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }
        
        
         // Helper function untuk status badge
        function getStatusBadge(keterangan) {
            const ket = keterangan.toLowerCase();
            let badgeClass = '';
            let badgeText = '';
            
            if (ket.includes('hadir')) {
                badgeClass = 'bg-green-100 text-green-800';
                badgeText = 'Hadir';
            } else if (ket.includes('alpa')) {
                badgeClass = 'bg-red-100 text-red-600';
                badgeText = 'Alpa';
            } else if (ket.includes('izin')) {
                badgeClass = 'bg-yellow-100 text-yellow-800';
                badgeText = 'Izin';
            } else if (ket.includes('sakit')) {
                badgeClass = 'bg-blue-100 text-blue-800';
                badgeText = 'Sakit';
            } else if (ket.includes('terlambat')) {
                badgeClass = 'bg-orange-100 text-orange-800';
                badgeText = 'Terlambat';
            } else {
                badgeClass = 'bg-purple-100 text-purple-800';
                badgeText = 'Bolos';
            }
            
            return `<span class="px-2 py-1 text-xs font-medium rounded-full ${badgeClass}">${badgeText}</span>`;
        }
        
     // Fungsi untuk menampilkan tanggal
          function renderHeader() {
            const now = new Date();
            const options = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' };
            
            // Memilih elemen dengan ID 'dateLabel' menggunakan JavaScript standar
            const dateElement = document.getElementById('dateLabel');
            
            // Mengisi teks tanggal dengan format Bahasa Indonesia
            dateElement.textContent = now.toLocaleDateString('id-ID', options);
          }
          // Menjalankan fungsi renderHeader() saat halaman selesai dimuat
          document.addEventListener('DOMContentLoaded', renderHeader);
        
        // Fungsi untuk menampilkan rekap periode
        // function displayPeriodRecap() {
        //     const container = document.getElementById('periodRecap');
        //     const noDataMessage = document.getElementById('noPeriodData');
            
            // Grup data berdasarkan bulan
        //     const periodData = {};
        //     allData.forEach(item => {
        //         if (!item.tanggal) return;
                
        //         const period = item.bulan || item.tanggal.substring(0, 7);
                
        //         if (!periodData[period]) {
        //             periodData[period] = {
        //                 hadir: 0,
        //                 alpa: 0,
        //                 sakit: 0,
        //                 izin: 0,
        //                 terlambat: 0,
        //                 total: 0
        //             };
        //         }
                
        //         const ket = item.keterangan.toLowerCase();
        //         if (ket.includes('hadir')) periodData[period].hadir++;
        //         else if (ket.includes('alpa')) periodData[period].alpa++;
        //         else if (ket.includes('sakit')) periodData[period].sakit++;
        //         else if (ket.includes('izin')) periodData[period].izin++;
        //         else if (ket.includes('terlambat')) periodData[period].terlambat++;
                
        //         periodData[period].total++;
        //     });
            
        //     if (Object.keys(periodData).length === 0) {
        //         container.classList.add('hidden');
        //         noDataMessage.classList.remove('hidden');
        //         return;
        //     }
            
        //     container.classList.remove('hidden');
        //     noDataMessage.classList.add('hidden');
        //     container.innerHTML = '';
            
        //     Object.entries(periodData).forEach(([period, data]) => {
        //         const row = document.createElement('tr');
        //         row.className = 'hover:bg-gray-50';
                
        //         row.innerHTML = `
        //             <td class="px-4 py-3 font-medium text-gray-800">${period}</td>
        //             <td class="px-4 py-3 text-green-600 font-medium">${data.hadir}</td>
        //             <td class="px-4 py-3 text-red-600 font-medium">${data.alpa}</td>
        //             <td class="px-4 py-3 text-purple-600 font-medium">${data.sakit}</td>
        //             <td class="px-4 py-3 text-yellow-600 font-medium">${data.izin}</td>
        //             <td class="px-4 py-3 font-bold text-gray-800">${data.total}</td>
        //         `;
                
        //         container.appendChild(row);
        //     });
        // }
        
        // Fungsi helper untuk status
        // Fungsi helper untuk status
        function getStatusClass(keterangan) {
            const ket = keterangan.toLowerCase();
            if (ket.includes('hadir')) return 'bg-green-100';
            if (ket.includes('alpa')) return 'bg-red-100';
            if (ket.includes('izin')) return 'bg-yellow-100';
            if (ket.includes('sakit')) return 'bg-blue-100';
            if (ket.includes('terlambat')) return 'bg-orange-100';
            return 'bg-purple-100';
        }
        
        // ✓
        
        function getStatusIcon(keterangan) {
            const ket = keterangan.toLowerCase();
            if (ket.includes('hadir')) return '<i class="fas fa-check text-green-600 text-sm"></i>';
            if (ket.includes('alpa')) return '<i class="fas fa-times text-red-500 text-sm"></i>';
            if (ket.includes('izin')) return '<i class="fas fa-envelope text-yellow-600 text-sm"></i>';
            if (ket.includes('sakit')) return '<i class="fas fa-stethoscope text-blue-600 text-sm"></i>';
            if (ket.includes('terlambat')) return '<i class="fas fa-hourglass-end"></i>';
            return '<i class="fas fa-user-slash text-purple-600 text-sm"></i>';
        }
        
        // Fungsi untuk cek kartu presensi
        function checkCard() {
            showToast('Fitur cek kartu presensi akan segera tersedia!', 'info');
        }
        
        // Fungsi untuk export data
        function exportData() {
            if (allData.length === 0) {
                showToast('Tidak ada data untuk diekspor', 'warning');
                return;
            }
            
            const headers = ['Tanggal', 'Bulan', 'Jam', 'Scan', 'Nama Siswa', 'Nama Lengkap', 'No HP', 'Rombel', 'Kelas', 'Keterangan', 'Catatan', 'Mata Pelajaran', 'Jam Pelajaran'];
            const csvContent = [
                headers.join(','),
                ...allData.map(item => [
                    item.tanggal,
                    item.bulan,
                    item.jam,
                    item.scan,
                    `"${item.namaSiswa}"`,
                    `"${item.namaLengkap}"`,
                    item.nohp,
                    `"${item.rombel}"`,
                    `"${item.kelas}"`,
                    `"${item.keterangan}"`,
                    `"${item.catatan || ''}"`,
                    `"${item.mataPelajaran}"`,
                    item.jamPelajaran
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `presensi_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Data berhasil diekspor!', 'success');
        }
        
        // Event listeners untuk filter
        // document.getElementById('filterDate').addEventListener('change', () => {
        //     displayRecentAttendance();
        //     displayPeriodRecap();
        // });
        
        // document.getElementById('filterMonth').addEventListener('change', () => {
        //     displayRecentAttendance();
        //     displayPeriodRecap();
        // });
        
        // document.getElementById('filterKelas').addEventListener('change', () => {
        //     displayRecentAttendance();
        //     displayPeriodRecap();
        // });
        
        // document.getElementById('rekapKelas').addEventListener('change', (e) => {
        //     displayClassRecap(e.target.value);
        // });
        
        // Fungsi untuk update status koneksi
        function updateConnectionStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const lastUpdate = document.getElementById('lastUpdate');
            
            // Reset classes
            indicator.className = 'w-2 h-2 rounded-full status-indicator';
            
            switch(status) {
                case 'online':
                    indicator.classList.add('status-online', 'pulse-animation');
                    statusText.textContent = text;
                    statusText.className = 'font-medium text-green-600';
                    break;
                case 'offline':
                    indicator.classList.add('status-error');
                    indicator.classList.remove('pulse-animation');
                    statusText.textContent = 'Offline';
                    statusText.className = 'font-medium text-red-600';
                    break;
                case 'error':
                    indicator.classList.add('status-error');
                    indicator.classList.remove('pulse-animation');
                    statusText.textContent = text;
                    statusText.className = 'font-medium text-yellow-600';
                    break;
                case 'loading':
                    indicator.classList.add('status-loading', 'pulse-animation');
                    statusText.textContent = text;
                    statusText.className = 'font-medium text-blue-600';
                    break;
            }
            
            // Update last update time
            updateLastUpdateTime();
        }
        
        // Fungsi untuk update waktu terakhir update
        function updateLastUpdateTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            if (lastUpdateTime) {
                const timeAgo = getTimeAgo(lastUpdateTime);
                lastUpdate.textContent = `• ${timeAgo}`;
            } else {
                lastUpdate.textContent = '• belum ada update';
            }
        }
        
        // Fungsi untuk mendapatkan waktu relatif
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 5) {
                return 'baru saja';
            } else if (diffInSeconds < 60) {
                return `${diffInSeconds} detik lalu`;
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes} menit lalu`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours} jam lalu`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days} hari lalu`;
            }
        }
        
        // Fungsi untuk update waktu saat ini
        // function updateCurrentTime() {
        //     const currentTimeElement = document.getElementById('currentTime');
        //     const now = new Date();
        //     const timeString = now.toLocaleTimeString('id-ID', {
        //         hour: '2-digit',
        //         minute: '2-digit',
        //         second: '2-digit'
        //     });
        //     currentTimeElement.textContent = timeString;
        // }
        
        // Fungsi untuk memulai auto refresh
        function startAutoRefresh() {
            // Clear existing intervals if any
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // Set next refresh time
            nextRefreshTime = new Date(Date.now() + refreshRate);
            
            // Start auto refresh every 10 seconds
            refreshInterval = setInterval(() => {
                console.log('Auto refresh triggered at:', new Date().toLocaleTimeString());
                nextRefreshTime = new Date(Date.now() + refreshRate);
                
                fetchDataFromSheets().catch(error => {
                    console.error('Auto refresh failed:', error);
                    // Don't stop auto refresh on error, just log it
                });
            }, refreshRate);
            
            console.log('Auto refresh started - will update every', refreshRate/1000, 'seconds');
            showToast(`Auto refresh aktif - update setiap ${refreshRate/1000} detik`, 'info', 2000);
        }
        
        // Fungsi untuk refresh manual
        function manualRefresh() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('refresh-spin');
            
            // Reset next refresh time
            nextRefreshTime = new Date(Date.now() + refreshRate);
            
            fetchDataFromSheets(true).then(() => {
                showToast('Data berhasil diperbarui!', 'success', 2000);
            }).catch(error => {
                showToast('Gagal memperbarui data. Coba lagi.', 'error');
            }).finally(() => {
                setTimeout(() => {
                    icon.classList.remove('refresh-spin');
                }, 1000);
            });
        }
        
        // Fungsi untuk notifikasi suara (opsional)
        function playNotificationSound() {
            try {
                // Create audio context for notification sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                // Ignore audio errors
                console.log('Audio notification not supported');
            }
        }
        
        // Event listeners untuk koneksi
        window.addEventListener('online', () => {
            isOnline = true;
            consecutiveErrors = 0; // Reset error counter
            updateConnectionStatus('online', 'Kembali online');
            showToast('Koneksi internet kembali normal', 'success');
            startAutoRefresh();
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus('offline', 'Tidak ada koneksi');
            showToast('Koneksi internet terputus', 'error');
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        });
        
        // Fungsi untuk update countdown
        function updateCountdown() {
            const nextRefreshElement = document.getElementById('nextRefresh');
            if (nextRefreshTime && refreshInterval) {
                const now = new Date();
                const timeLeft = Math.max(0, Math.ceil((nextRefreshTime - now) / 1000));
                
                if (timeLeft > 0) {
                    nextRefreshElement.textContent = `• refresh dalam ${timeLeft}s`;
                } else {
                    nextRefreshElement.textContent = '• sedang refresh...';
                }
            } else {
                nextRefreshElement.textContent = '';
            }
        }
        
        // Update waktu setiap detik
        setInterval(() => {
            updateCurrentTime();
            updateLastUpdateTime();
            updateCountdown();
        }, 1000);
        
        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing system...');
            manualRefresh();
            document.getElementById('refreshButton').addEventListener('click', manualRefresh);
            updateCurrentTime();
            updateConnectionStatus('loading', 'Memuat...');
            
            // Load data pertama kali dan mulai auto refresh
            fetchDataFromSheets(true).then(() => {
                console.log('Initial data loaded successfully');
                startAutoRefresh();
                
                // Show welcome toast after successful initialization
                setTimeout(() => {
                    showToast('Sistem presensi siap digunakan! Data akan ter-refresh otomatis setiap 10 detik.', 'success');
                }, 500);
            }).catch(error => {
                console.error('Failed to load initial data:', error);
                updateConnectionStatus('error', 'Gagal memuat data awal');
                showToast('Gagal memuat data awal. Mencoba ulang...', 'error');
                
                // Retry after 5 seconds
                setTimeout(() => {
                    fetchDataFromSheets(true).then(() => {
                        startAutoRefresh();
                    });
                }, 5000);
            });
        });
        
        // Fallback initialization if DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            // DOM is still loading
        } else {
            // DOM is already loaded
            console.log('DOM already loaded, initializing system...');
            
            updateCurrentTime();
            updateConnectionStatus('loading', 'Memuat...');
            
            fetchDataFromSheets(true).then(() => {
                console.log('Initial data loaded successfully');
                startAutoRefresh();
                
                setTimeout(() => {
                    showToast('Sistem presensi siap digunakan! Data akan ter-refresh otomatis setiap 10 detik.', 'success');
                }, 500);
            }).catch(error => {
                console.error('Failed to load initial data:', error);
                updateConnectionStatus('error', 'Gagal memuat data awal');
                showToast('Gagal memuat data awal. Mencoba ulang...', 'error');
                
                setTimeout(() => {
                    fetchDataFromSheets(true).then(() => {
                        startAutoRefresh();
                    });
                }, 5000);
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a38f1de6f7604a',t:'MTc1NDM2ODIyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
